---
import Project from '@/pages/projects/[...page].astro';
import type {
  IProjectFrontmatter,
  ProjectFrontmatterPage,
} from '@/types/IProjectFrontmatter';
import { sortByDate } from '@/utils/Posts';
import type { StaticPost } from '@/utils/StaticPages';
import { DormitoryIntroduction } from '@/utils/StaticPages';
import { readYears } from '@/utils/Year';

type GetStaticPaths = {
  paginate: any;
}; // Overrides `GetStaticPathsOptions` types from Astro

export async function getNonDraftPosts() {
  const allPosts: StaticPost[] = await Astro.glob<IProjectFrontmatter>(
    '../../*.md'
  );
  allPosts.push(DormitoryIntroduction);

  const nonDraftPosts = allPosts.filter((post) => !post.frontmatter.draft);

  return nonDraftPosts;
}

export async function getStaticPaths({ paginate }: GetStaticPaths) {
  const nonDraftPosts = await getNonDraftPosts();
  const sortedPosts = sortByDate(nonDraftPosts);

  const years = await readYears();

  return years.projects.map((year) => {
    const filteredPosts = sortedPosts.filter((post) => {
      const publishYear = new Date(post.frontmatter.pubDate).getFullYear();
      return publishYear === year;
    });

    return paginate(filteredPosts, {
      params: { year: year.toString() },
      pageSize: 9,
    });
  });
}

interface Props {
  page: ProjectFrontmatterPage;
}

const { page } = Astro.props as Props;
const { year } = Astro.params;
---

<Project page={page} preTitle={year} />
